<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>edit (DatacolumnsController)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File app/controllers/datacolumns_controller.rb, line 15</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit</span>
    <span class="ruby-keyword kw">begin</span>
      <span class="ruby-comment cmt"># Get the central Data Column object from the database.</span>
      <span class="ruby-ivar">@data_column</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Datacolumn</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
      <span class="ruby-ivar">@data_groups_available</span> = <span class="ruby-constant">Datagroup</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
                                              <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;title&quot;</span>,
                                              <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;id &lt;&gt; ?&quot;</span>, <span class="ruby-ivar">@data_column</span>.<span class="ruby-identifier">datagroup</span>.<span class="ruby-identifier">id</span>])

      <span class="ruby-comment cmt"># Is the Data Group of this Data Column approved? If no, then render the Data Group approval partial.</span>
      <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@data_column</span>.<span class="ruby-identifier">datagroup_approved?</span>
        <span class="ruby-identifier">render</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'approve_datagroup'</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">return</span>
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-comment cmt"># get the datatype of this column for correct preselection</span>
      <span class="ruby-ivar">@datatype</span> = <span class="ruby-constant">Datatypehelper</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-ivar">@data_column</span>.<span class="ruby-identifier">import_data_type</span>)

      <span class="ruby-comment cmt"># Is the Data Type of this Data Column approved? If no, then render the Data Type approval partial.</span>
      <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@data_column</span>.<span class="ruby-identifier">datatype_approved?</span>
        <span class="ruby-identifier">render</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'approve_datatype'</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">return</span>
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-ivar">@dataset</span> = <span class="ruby-ivar">@data_column</span>.<span class="ruby-identifier">dataset</span>
      <span class="ruby-ivar">@available_categories</span> = <span class="ruby-ivar">@data_column</span>.<span class="ruby-identifier">datagroup</span>.<span class="ruby-identifier">categories</span>.<span class="ruby-identifier">order</span>(<span class="ruby-identifier">:short</span>)
      <span class="ruby-ivar">@invalid_values_hash</span> = <span class="ruby-ivar">@data_column</span>.<span class="ruby-identifier">invalid_values</span>

      <span class="ruby-comment cmt"># User has to have a look on values that were marked as invalid</span>
      <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@invalid_values_hash</span>.<span class="ruby-identifier">blank?</span>
        <span class="ruby-identifier">render</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'approve_categories'</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">return</span>
      <span class="ruby-keyword kw">end</span>
      <span class="ruby-comment cmt"># Collect all methods for the select tag.</span>
      <span class="ruby-ivar">@methods_short_list</span> = <span class="ruby-constant">Datagroup</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;title&quot;</span>).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">m</span>.<span class="ruby-identifier">title</span>, <span class="ruby-identifier">m</span>.<span class="ruby-identifier">id</span>]}

      <span class="ruby-comment cmt"># Collect the already linked people.</span>
      <span class="ruby-ivar">@ppl</span> = <span class="ruby-ivar">@data_column</span>.<span class="ruby-identifier">users</span>

      <span class="ruby-comment cmt"># Unfinished datacolumn means, the user must have at least one look on the metadata and members involved.</span>
      <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@data_column</span>.<span class="ruby-identifier">finished</span>
        <span class="ruby-identifier">render</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'approve_metadata'</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">return</span>
      <span class="ruby-keyword kw">end</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>
    <span class="ruby-keyword kw">rescue</span>
      <span class="ruby-comment cmt"># The tabbed display prevent the usual error messages from being displayed.</span>
      <span class="ruby-comment cmt"># We therefore catch all exceptions and display a generic error message along with the exception itself.</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;Sorry, there is a problem loading the page. Error: #{$!}&quot;</span>
      <span class="ruby-comment cmt">#raise</span>
    <span class="ruby-keyword kw">end</span>
  <span class="ruby-keyword kw">end</span></pre>
</body>
</html>