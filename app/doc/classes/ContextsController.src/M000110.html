<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>download (ContextsController)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File controllers/contexts_controller.rb, line 305</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">download</span>
    <span class="ruby-identifier">require</span> <span class="ruby-value str">'spreadsheet'</span>
    <span class="ruby-identifier">context</span> = <span class="ruby-constant">Context</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])

    <span class="ruby-identifier">report</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>

    <span class="ruby-constant">Spreadsheet</span>.<span class="ruby-identifier">client_encoding</span> = <span class="ruby-value str">'UTF-8'</span>
    <span class="ruby-identifier">book</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Workbook</span>.<span class="ruby-identifier">new</span>

    <span class="ruby-comment cmt"># Define the formats for the spreadsheet</span>
    <span class="ruby-identifier">formats</span> = {}
    <span class="ruby-identifier">formats</span>[<span class="ruby-identifier">:dataformat</span>] = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">11</span>, <span class="ruby-identifier">:horizontal_align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:left</span>, <span class="ruby-identifier">:italic</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
    <span class="ruby-identifier">formats</span>[<span class="ruby-identifier">:metaformat</span>] = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">11</span>, <span class="ruby-identifier">:horizontal_align</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:left</span>, <span class="ruby-identifier">:color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'brown'</span>

    <span class="ruby-comment cmt"># Write the metadata sheet</span>
    <span class="ruby-identifier">create_metasheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>)

    <span class="ruby-comment cmt"># This loop checks the Vip/Vop-status for every PersonRole, the current user plays.</span>
    <span class="ruby-comment cmt"># If any status is found, the appropriate download is allowed.</span>
    <span class="ruby-identifier">vip</span> = <span class="ruby-keyword kw">false</span>
    <span class="ruby-identifier">vop</span> = <span class="ruby-keyword kw">false</span>
    <span class="ruby-identifier">funding</span> = <span class="ruby-keyword kw">false</span>
    <span class="ruby-identifier">data_requester</span> = <span class="ruby-keyword kw">false</span>

    <span class="ruby-identifier">roles</span> = <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">person_roles</span>
    <span class="ruby-identifier">roles</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">vip</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">context</span>.<span class="ruby-identifier">vips</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">role</span>)
      <span class="ruby-identifier">vop</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">context</span>.<span class="ruby-identifier">vops</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">role</span>)
      <span class="ruby-identifier">funding</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">context</span>.<span class="ruby-identifier">fundings</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">role</span>)
    <span class="ruby-keyword kw">end</span>
    <span class="ruby-identifier">data_requester</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">context</span>.<span class="ruby-identifier">data_requester_from_data_columns_include?</span>(<span class="ruby-ivar">@current_user</span>)

    <span class="ruby-comment cmt"># Check which group the current user belongs to</span>
    <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:t</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'vip'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">vip</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">true</span>
      <span class="ruby-comment cmt"># If she's a Vip: Send the full download</span>
      <span class="ruby-identifier">create_methodsheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>)
      <span class="ruby-identifier">create_peoplesheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>)
      <span class="ruby-identifier">create_categorysheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>)
      <span class="ruby-comment cmt"># if data sheet is too large, it has to be saved</span>
      <span class="ruby-comment cmt"># as .csv file</span>
      <span class="ruby-identifier">create_datasheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>)

      <span class="ruby-comment cmt"># this should be basename and then the number of the download</span>
      <span class="ruby-identifier">filename</span> = <span class="ruby-node">&quot;download#{context.downloads}_#{context.filename}&quot;</span>

    <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:t</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'vop'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">vop</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">true</span>
      <span class="ruby-comment cmt"># If she's a Vop: Send a partial download</span>
      <span class="ruby-identifier">mms</span> = <span class="ruby-constant">MeasurementsMethodstep</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>,
                                        <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;context_id = ?&quot;</span>, <span class="ruby-identifier">context</span>.<span class="ruby-identifier">id</span>],
                                        <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;columnnr ASC&quot;</span>)
      <span class="ruby-identifier">methods</span> = []

      <span class="ruby-identifier">mms</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">step</span><span class="ruby-operator">|</span>
        <span class="ruby-comment cmt">## collect all the projects that may download the measmeth;</span>
        <span class="ruby-comment cmt">## collect all the projects the current user participates in</span>
        <span class="ruby-identifier">step</span>.<span class="ruby-identifier">measmeths_personroles</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">mmpr</span><span class="ruby-operator">|</span>
          <span class="ruby-comment cmt"># Each MeasmethsPersonrole is checked whether it points to the current user or not</span>
          <span class="ruby-identifier">persRoleInMeasmeth</span> = <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">person_roles</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">mmpr</span>.<span class="ruby-identifier">person_role</span>)
          <span class="ruby-comment cmt">## if a person is part of those that can freely download a</span>
          <span class="ruby-comment cmt">## context, then every Measmeth is included</span>
          <span class="ruby-identifier">persRoleInFreeperson</span> =  <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">context_freepeople</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">cfp</span><span class="ruby-operator">|</span> <span class="ruby-identifier">cfp</span>.<span class="ruby-identifier">context</span>}.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">context</span>)
          <span class="ruby-comment cmt">## same is true for people part of projects which can download a context</span>
          <span class="ruby-identifier">contextFreeProject_pr</span> = <span class="ruby-identifier">context</span>.<span class="ruby-identifier">context_freeprojects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">cfp</span><span class="ruby-operator">|</span> <span class="ruby-identifier">cfp</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">person_roles</span>}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
          <span class="ruby-identifier">contextFreeProject_p</span> = <span class="ruby-identifier">contextFreeProject_pr</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">pr</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">person</span>}.<span class="ruby-identifier">uniq</span>
          <span class="ruby-identifier">persInFreeproject</span> = <span class="ruby-identifier">contextFreeProject_p</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@current_user</span>)
          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">persRoleInMeasmeth</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">persRoleInFreeperson</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">persInFreeproject</span>
            <span class="ruby-identifier">methods</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">step</span>
            <span class="ruby-comment cmt">## if the projects associated to a user include one of</span>
            <span class="ruby-comment cmt">## the projects that may download the measmeth, than it</span>
            <span class="ruby-comment cmt">## should also be added to the list</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span>


      <span class="ruby-identifier">methods</span> = <span class="ruby-identifier">methods</span>.<span class="ruby-identifier">uniq</span>

      <span class="ruby-identifier">create_methodsheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>, <span class="ruby-identifier">methods</span>)
      <span class="ruby-identifier">create_peoplesheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>, <span class="ruby-identifier">methods</span>)
      <span class="ruby-identifier">create_categorysheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>, <span class="ruby-identifier">methods</span>)
      <span class="ruby-identifier">create_datasheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>, <span class="ruby-identifier">methods</span>)

      <span class="ruby-identifier">filename</span> = <span class="ruby-node">&quot;download#{context.downloads}_#{@current_user.path_name}_#{context.filename}&quot;</span>

    <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">funding</span>
      <span class="ruby-comment cmt"># If he's a funding source: Send a virtual context</span>

    <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">data_requester</span>
      <span class="ruby-identifier">methods</span> = []
      <span class="ruby-identifier">data_requests_used_this_context</span> = <span class="ruby-identifier">context</span>.<span class="ruby-identifier">measurements_methodsteps</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">data_column</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data_column</span>.<span class="ruby-identifier">data_requests</span>}.<span class="ruby-identifier">flatten</span>
      <span class="ruby-comment cmt">#only final ones</span>
      <span class="ruby-identifier">final_data_requests</span> = <span class="ruby-identifier">data_requests_used_this_context</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">data_request</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data_request</span>.<span class="ruby-identifier">board_state</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;final&quot;</span>}.<span class="ruby-identifier">uniq</span>

      <span class="ruby-identifier">all_requested_data_columns</span> = <span class="ruby-identifier">final_data_requests</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data_request</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data_request</span>.<span class="ruby-identifier">measurements_methodsteps</span>}.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>

      <span class="ruby-identifier">all_requested_data_columns</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">data_column</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">methods</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data_column</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">data_column</span>.<span class="ruby-identifier">context</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">context</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-identifier">methods</span> = <span class="ruby-identifier">methods</span>.<span class="ruby-identifier">uniq</span>

      <span class="ruby-identifier">methods</span> = <span class="ruby-identifier">methods</span>.<span class="ruby-identifier">uniq</span>

      <span class="ruby-identifier">create_methodsheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>, <span class="ruby-identifier">methods</span>)
      <span class="ruby-identifier">create_peoplesheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>, <span class="ruby-identifier">methods</span>)
      <span class="ruby-identifier">create_categorysheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>, <span class="ruby-identifier">methods</span>)
      <span class="ruby-identifier">create_datasheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">context</span>, <span class="ruby-identifier">formats</span>, <span class="ruby-identifier">methods</span>)

      <span class="ruby-identifier">filename</span> = <span class="ruby-node">&quot;download#{context.downloads}_#{@current_user.path_name}_#{context.filename}&quot;</span>

    <span class="ruby-keyword kw">else</span>
      <span class="ruby-comment cmt"># Logged in but no rights to download anything. Just go back.</span>
      <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">redirect_to</span> <span class="ruby-operator">:</span><span class="ruby-identifier">back</span>
    <span class="ruby-keyword kw">end</span>

    <span class="ruby-comment cmt"># Write the book to the stream and send it back to the browser</span>
    <span class="ruby-identifier">book</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">report</span>)
    <span class="ruby-identifier">send_data</span> <span class="ruby-identifier">report</span>.<span class="ruby-identifier">string</span>, <span class="ruby-identifier">:content_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;application/xls&quot;</span>, <span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filename</span>

    <span class="ruby-comment cmt"># Add 1 to the download counter</span>
    <span class="ruby-identifier">context</span>.<span class="ruby-identifier">downloads</span> = (<span class="ruby-identifier">context</span>.<span class="ruby-identifier">downloads</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>) <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">context</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-keyword kw">end</span></pre>
</body>
</html>